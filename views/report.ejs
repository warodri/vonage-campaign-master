<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        @media print {
            .no-print {
                display: none;
            }

            .table {
                font-size: 10px;
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-primary no-print">
        <div class="container-fluid">
            <a href="/" class="navbar-brand">Campaing Report</a>
            <div>
                <button onclick="window.print()" class="btn btn-light btn-sm me-2">
                    <i class="bi bi-printer"></i> Print
                </button>
                <a href="/" class="btn btn-light btn-sm">New Report</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row no-print">
            <div class="col-12">
                <div class="alert alert-info">
                    <strong>Date Range:</strong> <%= dateFrom %> to <%= dateTo %> | 
                    <strong>Report Generated:</strong> <%= data.metadata?.generatedAt 
                    ? new Date(data.metadata.generatedAt).toLocaleString() 
                    : 'N/A' %>
                    | 
                    <strong>Total Records:</strong> <%= data.metadata.totalRecords.toLocaleString() %> | 
                    <strong>Currency:</strong> <%= data.currency %>
                </div>
            </div>
        </div>

        <% data.accounts.forEach(account=> { %>
            <div class="mb-5">
                <h3 class="text-primary border-bottom pb-2">Account ID: <%= account.accountId %>
                </h3>
                <p class="text-muted">Total Records: <%= account.totalCount.toLocaleString() %>
                </p>

                <div class="table-responsive">
                    <table class="table table-bordered table-hover pivot-table">
                        <thead class="table-light">
                            <tr>
                                <th class="group-header">Group</th>
                                <th class="text-center">Count</th>
                                <% priceColumns.forEach(priceCol=> { %>
                                    <th class="text-end"><%= getLabel(priceCol) %></th>
                                <% }); %>
                            </tr>
                        </thead>
                        <tbody>
                            <% account.groups.forEach(group=> { %>
                                <!-- Main Group Header -->
                                <tr class="table-dark">
                                    <td colspan="<%= 2 + priceColumns.length %>" class="fw-bold">
                                        <%= getLabel(group.groupColumn) %>: <%= group.groupValue %>
                                    </td>
                                </tr>

                                <% if (group.nestedGroups && group.nestedGroups.length> 0) { %>
                                    <% group.nestedGroups.forEach(nestedGroup=> { %>
                                        <%- renderNestedGroup(nestedGroup, priceColumns, account.currency, 0) %>
                                            <% }); %>
                                                <% } %>

                                                    <!-- Group Subtotal -->
                                                    <tr class="table-secondary fw-bold">
                                                        <td>Subtotal for <%= group.groupValue %>
                                                        </td>
                                                        <td class="text-center">
                                                            <%= group.count.toLocaleString() %>
                                                        </td>
                                                        <% priceColumns.forEach(priceCol=> { %>
                                                            <td class="text-end">
                                                                <%= formatCurrency(group.totals[priceCol],
                                                                    account.currency) %>
                                                            </td>
                                                            <% }); %>
                                                    </tr>
                                                    <% }); %>

                                                        <!-- Grand Total -->
                                                        <tr class="table-dark text-white fw-bold">
                                                            <td>GRAND TOTAL</td>
                                                            <td class="text-center">
                                                                <%= account.totalCount.toLocaleString() %>
                                                            </td>
                                                            <% priceColumns.forEach(priceCol=> { %>
                                                                <td class="text-end">
                                                                    <%= formatCurrency(account.grandTotals[priceCol],
                                                                        account.currency) %>
                                                                </td>
                                                                <% }); %>
                                                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <% }); %>
    </div>

  <%
  function renderNestedGroup(group, priceColumns, currency, indentLevel) {
    let html = '';
    
    if (group.column && group.value) {
      const indent = '　'.repeat(indentLevel);
      
      html += `<tr class="nested-group-${indentLevel}">`;
      html += `<td class="ps-${indentLevel + 2}">${indent}<strong>${getLabel(group.column)}:</strong> ${group.value}</td>`;
      html += `<td class="text-center text-muted"></td>`;
      priceColumns.forEach(() => {
        html += `<td class="text-end text-muted"></td>`;
      });
      html += `</tr>`;
  
      if (group.children && group.children.length > 0) {
        group.children.forEach(child => {
          html += renderNestedGroup(child, priceColumns, currency, indentLevel + 1);
        });
      }
    } else if (group.breakdownColumn && group.breakdownValue) {
      const indent = '　'.repeat(indentLevel);
      
      html += `<tr class="breakdown-row">`;
      html += `<td class="ps-${indentLevel + 3}">${indent}${getLabel(group.breakdownColumn)}: ${group.breakdownValue}</td>`;
      html += `<td class="text-center">${group.count.toLocaleString()}</td>`;
      priceColumns.forEach(priceCol => {
        html += `<td class="text-end">${formatCurrency(group.totals[priceCol], currency)}</td>`;
      });
      html += `</tr>`;
    }
    
    return html;
  }

  function formatCurrency(amount, currency) {
    const locale = getCurrencyLocale(currency);
    return new Intl.NumberFormat(locale, {
      style: 'currency',
      currency: currency,
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    }).format(amount);
  }

  function getCurrencyLocale(currency) {
    const localeMap = {
      'USD': 'en-US',
      'EUR': 'de-DE',
      'GBP': 'en-GB',
      'JPY': 'ja-JP',
      'SEK': 'sv-SE',
      'NOK': 'nb-NO',
      'DKK': 'da-DK',
      'CHF': 'de-CH',
      'CAD': 'en-CA',
      'AUD': 'en-AU'
    };
    return localeMap[currency] || 'en-US';
  }
  %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
