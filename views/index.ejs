<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <nav class="navbar navbar-dark bg-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">CSV Report Generator</span>
        </div>
    </nav>
    <div class="container">
        <div class="row justify-content-center">

            <!-- Dynamic Preview Section -->
            <div class="card shadow mt-4" id="previewCard">
                <div class="card-body">
                    <div class="mb-3 d-flex justify-content-between align-items-center gap-3">
                        <p class="text-muted" id="previewDescription">
                            Select your grouping options above to see how your report will be structured
                        </p>
                        <div>
                            <button id="but-toggle-preview" class="btn btn-primary rounded-4" onclick="toggleReportPreview()">
                                Hide
                            </button>
                        </div>
                    </div>
            
                    <div class="table-responsive border border-dark border-2 rounded" id="preview-report-table">
                        <table class="table table-bordered table-hover pivot-table mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th class="group-header">Group</th>
                                    <th class="text-center">Count</th>
                                    <th class="text-end" id="priceCol1">Price Column 1</th>
                                    <th class="text-end" id="priceCol2">Price Column 2</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-4">
                                        Select grouping options above to see preview
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-4 col-md-8">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">Generate Report</h4>
                    </div>
                    <div class="card-body">                            
                        <!-- Date Range -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="dateFrom" class="form-label"><b>Date From *</b></label>
                                <input type="date" class="form-control" id="dateFrom" name="dateFrom" required>
                                <div class="form-text">Start date for report data</div>
                            </div>
                            <div class="col-md-6">
                                <label for="dateTo" class="form-label"><b>Date To *</b></label>
                                <input type="date" class="form-control" id="dateTo" name="dateTo" required>
                                <div class="form-text">End date for report data</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="accountIds" class="form-label"><b>Account ID</b></label>
                            <input type="text" class="form-control" id="accountIds" name="accountIds" placeholder="76ea2717, 12345678" value="">
                            <div class="form-text">Type the account ID you want for the report. You can include its sub-accounts.</div>
                        </div>

                        <div class="form-check mb-3">
                            <input
                                class="form-check-input"
                                type="checkbox"
                                id="includeSubaccounts"
                                name="includeSubaccounts"
                            >
                            <label class="form-check-label" for="includeSubaccounts">
                                Include subaccounts
                            </label>
                            <div class="form-text">
                                If checked, data from all subaccounts under this account will be included
                            </div>
                        </div>                            
                    
                        <div class="mb-3">
                            <label for="groupBy" class="form-label"><b>Group By Column *</b></label>
                            <select class="form-control" id="groupBy" name="groupBy" required>
                                <option value="">-- Select a column --</option>
                                <% Object.entries(COLUMN_LABELS).forEach(([key, label])=> { %>
                                    <option value="<%= key %>" <%=key==='country_name' ? 'selected' : '' %>><%= label %></option>
                                <% }); %>
                            </select>
                            <div class="form-text">Main grouping column</div>
                        </div>
                    
                        <div class="mb-3">
                            <label for="internalGroupBy" class="form-label"><b>Internal Group By Columns</b></label>
                            <select class="form-control" id="internalGroupBy" name="internalGroupBy" multiple size="5">
                                <% Object.entries(COLUMN_LABELS).forEach(([key, label])=> { %>
                                    <option value="<%= key %>" <%=(key==='provider' || key==='session_type' ) ? 'selected' : '' %>><%= label %></option>
                                <% }); %>
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple columns for nested grouping</div>
                        </div>
                    
                        <div class="mb-3">
                            <label for="showTotalBy" class="form-label"><b>Show Total By Columns</b></label>
                            <select class="form-control" id="showTotalBy" name="showTotalBy" multiple size="5">
                                <% Object.entries(COLUMN_LABELS).forEach(([key, label])=> { %>
                                    <option value="<%= key %>" <%=key==='status' ? 'selected' : '' %>><%= label %></option>
                                <% }); %>
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple columns to break down totals</div>
                        </div>
                    
                        <div class="mb-3">
                            <label for="priceColumns" class="form-label"><b>Price Columns</b></label>
                            <select class="form-control" id="priceColumns" name="priceColumns" multiple size="4">
                                <% Object.entries(COLUMN_LABELS).forEach(([key, label])=> { %>
                                    <% if (key.includes('price') || key.includes('cost') || key.includes('amount')) { %>
                                        <option value="<%= key %>" <%=(key==='estimated_price' || key==='total_price' ) ? 'selected' : '' %>><%= label %></option>
                                    <% } %>
                                <% }); %>
                            </select>
                            <div class="form-text">Hold Ctrl/Cmd to select multiple price columns</div>
                        </div>
                    
                        <div id="waitingMessage" class="alert alert-warning mt-3 d-none text-center">
                            ⏳ Waiting for your report…
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-lg" id="generateBtn"> 
                                Generate Report
                            </button>
                        </div>

                    </div>
                </div>


                <div class="card shadow mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">Past Reports</h5>
                    </div>
                    <div class="card-body">
                        <div id="pastReports" class="text-muted">
                            Loading reports…
                        </div>
                    </div>
                </div>


                <div class="alert alert-info mt-4" role="alert">
                    <h5 class="alert-heading">How to Use</h5>
                    <ul class="mb-0">
                        <!-- <li><strong>CSV File Path:</strong> Provide the full path to your CSV file</li> -->
                        <li><strong>Account IDs:</strong> Filter by specific accounts (optional)</li>
                        <li><strong>Group By:</strong> Main grouping column (required)</li>
                        <li><strong>Internal Group By:</strong> Creates nested groups within each main group</li>
                        <li><strong>Show Total By:</strong> Breaks down the data within each nested group</li>
                        <li><strong>Price Columns:</strong> Columns to sum and display as totals</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('pastReports');
        
            try {
                const res = await fetch('/reports/history');
                const data = await res.json();
        
                if (!data.success || data.reports.length === 0) {
                    container.innerHTML = '<div class="text-muted">No past reports yet.</div>';
                    return;
                }
        
                container.innerHTML = data.reports.map(r => `
                    <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                        <div>
                            <div><strong>Account:</strong> ${r.payload.accountId}</div>
                            <div class="text-muted small">
                                ${new Date(r.createdAt).toLocaleString()}
                            </div>
                        </div>
                        <div>
                            ${
                                r.ready
                                ? `<form method="POST" action="/reports/open/${r.requestId}">
                                       <button class="btn btn-sm btn-outline-primary">
                                           Open
                                       </button>
                                   </form>`
                                : `<span class="badge bg-warning text-dark">Processing</span>`
                            }
                        </div>
                    </div>
                `).join('');
            } catch (err) {
                container.innerHTML = '<div class="text-danger">Failed to load reports.</div>';
            }
        });
    </script>

    <script>
        var reportPreviewVisible = true;
        function toggleReportPreview() {
            reportPreviewVisible = !reportPreviewVisible;
            const ele = document.getElementById('preview-report-table');
            const but = document.getElementById('but-toggle-preview');
            if (!reportPreviewVisible) {
                ele.classList.add('hidden')
                but.innerHTML = 'Show';
            } else {
                ele.classList.remove('hidden')
                but.innerHTML = 'Hide';
            }
        }
    </script>
    <script>
        // Set default dates (last 30 days)
        document.addEventListener('DOMContentLoaded', function () {
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));

            document.getElementById('dateTo').valueAsDate = today;
            document.getElementById('dateFrom').valueAsDate = thirtyDaysAgo;
        });

        function setDateRange(range) {
            const today = new Date();
            const dateToInput = document.getElementById('dateTo');
            const dateFromInput = document.getElementById('dateFrom');

            dateToInput.valueAsDate = today;

            if (range === 'month') {
                // First day of current month
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                dateFromInput.valueAsDate = firstDay;
            } else if (range === 'all') {
                // Set to a very old date (or you can remove the required attribute temporarily)
                const oldDate = new Date('2020-01-01');
                dateFromInput.valueAsDate = oldDate;
            } else {
                // Last N days
                const daysAgo = new Date(today.getTime() - (range * 24 * 60 * 60 * 1000));
                dateFromInput.valueAsDate = daysAgo;
            }

            // Add visual feedback
            dateFromInput.classList.add('border-success');
            dateToInput.classList.add('border-success');
            setTimeout(() => {
                dateFromInput.classList.remove('border-success');
                dateToInput.classList.remove('border-success');
            }, 500);
        }

        // Validate date range
        document.getElementById('dateFrom').addEventListener('change', validateDateRange);
        document.getElementById('dateTo').addEventListener('change', validateDateRange);

        function validateDateRange() {
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            if (dateFrom && dateTo && dateFrom > dateTo) {
                alert('Start date must be before end date');
                document.getElementById('dateFrom').value = '';
            }
        }
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const groupBySelect = document.getElementById('groupBy');
            const internalGroupBySelect = document.getElementById('internalGroupBy');
            const showTotalBySelect = document.getElementById('showTotalBy');
            const priceColumnsSelect = document.getElementById('priceColumns');

            const previewDescription = document.getElementById('previewDescription');
            const previewTableBody = document.getElementById('previewTableBody');
            const structureExplanation = document.getElementById('structureExplanation');
            const priceCol1 = document.getElementById('priceCol1');
            const priceCol2 = document.getElementById('priceCol2');

            function updatePreview() {
                // Add animation class
                document.getElementById('previewCard').classList.add('updated');
                setTimeout(() => {
                    document.getElementById('previewCard').classList.remove('updated');
                }, 500);
                
                const groupBy = groupBySelect.options[groupBySelect.selectedIndex];
                const internalGroups = Array.from(internalGroupBySelect.selectedOptions);
                const showTotal = Array.from(showTotalBySelect.selectedOptions);
                const priceColumns = Array.from(priceColumnsSelect.selectedOptions);

                // Update description
                if (groupBy && groupBy.value) {
                    let desc = `Group by <strong>${groupBy.text}</strong>`;

                    if (internalGroups.length > 0) {
                        desc += `, then nested by <strong>${internalGroups.map(opt => opt.text).join(' → ')}</strong>`;
                    }

                    if (showTotal.length > 0) {
                        desc += `, showing breakdowns by <strong>${showTotal.map(opt => opt.text).join(', ')}</strong>`;
                    }

                    previewDescription.innerHTML = desc;
                } else {
                    previewDescription.innerHTML = 'Select your grouping options above to see how your report will be structured';
                }

                // Update price column headers
                if (priceColumns.length > 0) {
                    priceCol1.textContent = priceColumns[0]?.text || 'Price Column 1';
                    priceCol2.textContent = priceColumns[1]?.text || 'Price Column 2';

                    // Show/hide columns based on selection
                    if (priceColumns.length < 2) {
                        priceCol2.style.display = 'none';
                        document.querySelectorAll('#previewTableBody td:nth-child(4)').forEach(td => {
                            td.style.display = 'none';
                        });
                    } else {
                        priceCol2.style.display = '';
                    }
                }

                // Generate preview table
                generatePreviewTable(groupBy, internalGroups, showTotal, priceColumns);

                // Update explanation
                updateStructureExplanation(groupBy, internalGroups, showTotal);
            }

            function generatePreviewTable(groupBy, internalGroups, showTotal, priceColumns) {
                if (!groupBy || !groupBy.value) {
                    previewTableBody.innerHTML = `
                        <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            Select <strong>Group By</strong> column to see preview
                        </td>
                        </tr>
                    `;
                    return;
                }

                const colSpan = 2 + priceColumns.length;
                let html = '';

                // Main Group Header
                html += `
                    <tr class="table-dark">
                        <td colspan="${colSpan}" class="fw-bold">
                        ${groupBy.text}: Example Value
                        </td>
                    </tr>
                `;

                // Internal Groups
                if (internalGroups.length > 0) {
                    internalGroups.forEach((group, index) => {
                        const indent = '　'.repeat(index);
                        const paddingClass = `ps-${index + 2}`;

                        html += `
                            <tr class="nested-group-${index}">
                                <td class="${paddingClass}">${indent}<strong>${group.text}:</strong> example_value</td>
                                <td class="text-center text-muted"></td>
                                ${priceColumns.map(() => '<td class="text-end text-muted"></td>').join('')}
                            </tr>
                        `;
                    });
                }

                // Show Total By (breakdown rows)
                if (showTotal.length > 0) {
                    const indentLevel = internalGroups.length;
                    const indent = '　'.repeat(indentLevel);
                    const paddingClass = `ps-${indentLevel + 3}`;

                    showTotal.forEach(breakdown => {
                        html += `
                            <tr class="breakdown-row">
                                <td class="${paddingClass}">${indent}${breakdown.text}: value_1</td>
                                <td class="text-center">150</td>
                                ${priceColumns.map(() => '<td class="text-end">1,234.56&nbsp;€</td>').join('')}
                            </tr>
                        `;
                    });

                    // Add a second example row
                    html += `
                        <tr class="breakdown-row">
                        <td class="${paddingClass}">${indent}${showTotal[0].text}: value_2</td>
                        <td class="text-center">89</td>
                        ${priceColumns.map(() => '<td class="text-end">987.65&nbsp;€</td>').join('')}
                        </tr>
                    `;
                } else if (internalGroups.length > 0) {
                    // If no breakdown, show a sample row
                    const indentLevel = internalGroups.length;
                    const indent = '　'.repeat(indentLevel);
                    const paddingClass = `ps-${indentLevel + 3}`;

                    html += `
                        <tr class="breakdown-row">
                        <td class="${paddingClass}">${indent}Detail Row</td>
                        <td class="text-center">239</td>
                        ${priceColumns.map(() => '<td class="text-end">2,222.21&nbsp;€</td>').join('')}
                        </tr>
                    `;
                } else {
                    // No internal groups, just show a row
                    html += `
                        <tr class="breakdown-row">
                        <td class="ps-2">Detail Row</td>
                        <td class="text-center">239</td>
                        ${priceColumns.map(() => '<td class="text-end">2,222.21&nbsp;€</td>').join('')}
                        </tr>
                    `;
                }

                // Subtotal
                html += `
                    <tr class="table-secondary fw-bold">
                        <td>Subtotal for Example Value</td>
                        <td class="text-center">239</td>
                        ${priceColumns.map(() => '<td class="text-end">2,222.21&nbsp;€</td>').join('')}
                    </tr>
                `;

                // Grand Total
                html += `
                    <tr class="table-dark text-white fw-bold">
                        <td>GRAND TOTAL</td>
                        <td class="text-center">5,432</td>
                        ${priceColumns.map(() => '<td class="text-end">12,345.67&nbsp;€</td>').join('')}
                    </tr>
                `;

                previewTableBody.innerHTML = html;
            }

            function updateStructureExplanation(groupBy, internalGroups, showTotal) {
                let explanation = '<li><span class="badge bg-primary">Blue rows</span> = Main groups';

                if (groupBy && groupBy.value) {
                    explanation += ` (${groupBy.text})`;
                }
                explanation += '</li>';

                if (internalGroups.length > 0) {
                    explanation += `<li><span class="badge bg-light text-dark">Light rows</span> = Nested groups (${internalGroups.map(g => g.text).join(' → ')})</li>`;
                }

                if (showTotal.length > 0) {
                    explanation += `<li><span class="badge bg-white text-dark border">White rows</span> = Detail breakdown (${showTotal.map(s => s.text).join(', ')} with counts & prices)</li>`;
                }

                explanation += '<li><span class="badge bg-secondary">Gray rows</span> = Subtotals per main group</li>';
                explanation += '<li><span class="badge bg-dark">Black row</span> = Grand total</li>';

                if (structureExplanation) {
                    structureExplanation.innerHTML = explanation;
                }
            }

            // Add event listeners
            groupBySelect.addEventListener('change', updatePreview);
            internalGroupBySelect.addEventListener('change', updatePreview);
            showTotalBySelect.addEventListener('change', updatePreview);
            priceColumnsSelect.addEventListener('change', updatePreview);

            // Initial preview with defaults
            updatePreview();
        });
    </script>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const waitingMessage = document.getElementById('waitingMessage');
        
        generateBtn.addEventListener('click', async () => {

            const accountIdValue = document
                .getElementById('accountIds')
                .value
                .trim();

            if (!accountIdValue) {
                waitingMessage.classList.remove('d-none');
                waitingMessage.classList.remove('alert-warning');
                waitingMessage.classList.add('alert-danger');
                waitingMessage.innerText = 'Account ID is required to generate a report.';
                return;
            }

            // 1. Collect form values
            const formData = {
                accountId: accountIdValue,
                dateFrom: document.getElementById('dateFrom').value,
                dateTo: document.getElementById('dateTo').value,
                includeSubaccounts: document.getElementById('includeSubaccounts').checked,
                groupBy: document.getElementById('groupBy').value,
                internalGroupBy: Array.from(
                    document.getElementById('internalGroupBy').selectedOptions
                ).map(o => o.value),
                showTotalBy: Array.from(
                    document.getElementById('showTotalBy').selectedOptions
                ).map(o => o.value),
                priceColumns: Array.from(
                    document.getElementById('priceColumns').selectedOptions
                ).map(o => o.value),
            };

            // 2. Ask for report
            const askResponse = await fetch('/ask-report', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
        
            const askData = await askResponse.json();
        
            if (!askData.success || !askData.request_id) {
                alert('Failed to request report');
                return;
            }
        
            const requestId = askData.request_id;
        
            // 3. Show waiting message
            waitingMessage.classList.remove('d-none');
        
            // 4. Poll readiness (every 4 seconds)
            const pollInterval = setInterval(async () => {
                const readyRes = await fetch(`/reports/ready/${requestId}`);
                const readyData = await readyRes.json();
        
                if (readyData.success && readyData.ready) {
                    clearInterval(pollInterval);
        
                    // 5. Send data to /generate-report
                    submitGenerateReport(requestId, readyData.payload);
                }
            }, 4000); 
        });
        
        function submitGenerateReport(requestId, payload) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/generate-report';
        
            const fields = {
                requestId,
                dateFrom: payload.payload.dateFrom,
                dateTo: payload.payload.dateTo,
                accountId: payload.payload.accountId,
                groupBy: payload.payload.groupBy,
                internalGroupBy: payload.payload.internalGroupBy,
                showTotalBy: payload.payload.showTotalBy,
                priceColumns: payload.payload.priceColumns,
            };
        
            Object.entries(fields).forEach(([key, value]) => {
                if (value === undefined || value === null) return;        
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = Array.isArray(value) ? value.join(',') : value;
                form.appendChild(input);
            });
        
            document.body.appendChild(form);
            form.submit();
        }
        </script>
</body>
</html>